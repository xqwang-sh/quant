<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Capital Asset Pricing Model (CAPM) Empirical Test – 量化投资课程讲义</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03_ff3.html" rel="next">
<link href="./02_capm.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2486e1f0a3ee9ee1fc393803a1361cdb.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-4140c5528bad55d065fb0dfc8d36ff91.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./lab02_capmtest.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capital Asset Pricing Model (CAPM) Empirical Test</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">量化投资课程讲义</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Preface</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_emh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Efficient Market Hypothesis (EMH)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Capital Asset Pricing Model (CAPM)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab02_capmtest.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capital Asset Pricing Model (CAPM) Empirical Test</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_ff3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Fama-French Three-Factor Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./lab03_ff3test.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Practice: Building and Backtesting the China-Specific Three-Factor Model (CH-3)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_selecting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Return Models and Portfolio Optimization</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Factor Timing and Style Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_alternative.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Outlook for Factor Investing: Alternative Data and Machine Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project1_factor.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Project 1: Factor Investing Strategy Construction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./project2_enhance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Project 2: Optimization and Enhancement of Factor Investing Strategies</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#lab-objectives" id="toc-lab-objectives" class="nav-link active" data-scroll-target="#lab-objectives"><span class="header-section-number">4.1</span> Lab Objectives</a></li>
  <li><a href="#lab-principles" id="toc-lab-principles" class="nav-link" data-scroll-target="#lab-principles"><span class="header-section-number">4.2</span> Lab Principles</a>
  <ul class="collapse">
  <li><a href="#capm-model-review" id="toc-capm-model-review" class="nav-link" data-scroll-target="#capm-model-review"><span class="header-section-number">4.2.1</span> CAPM Model Review</a></li>
  <li><a href="#empirical-testing-methods-for-capm-model" id="toc-empirical-testing-methods-for-capm-model" class="nav-link" data-scroll-target="#empirical-testing-methods-for-capm-model"><span class="header-section-number">4.2.2</span> Empirical Testing Methods for CAPM Model</a></li>
  </ul></li>
  <li><a href="#lab-data" id="toc-lab-data" class="nav-link" data-scroll-target="#lab-data"><span class="header-section-number">4.3</span> Lab Data</a></li>
  <li><a href="#lab-steps" id="toc-lab-steps" class="nav-link" data-scroll-target="#lab-steps"><span class="header-section-number">4.4</span> Lab Steps</a>
  <ul class="collapse">
  <li><a href="#import-necessary-python-libraries" id="toc-import-necessary-python-libraries" class="nav-link" data-scroll-target="#import-necessary-python-libraries"><span class="header-section-number">4.4.1</span> Import Necessary Python Libraries</a></li>
  </ul></li>
  <li><a href="#lab-results" id="toc-lab-results" class="nav-link" data-scroll-target="#lab-results"><span class="header-section-number">4.5</span> Lab Results</a></li>
  <li><a href="#conclusion-and-discussion" id="toc-conclusion-and-discussion" class="nav-link" data-scroll-target="#conclusion-and-discussion"><span class="header-section-number">4.6</span> Conclusion and Discussion</a></li>
  <li><a href="#lab-summary" id="toc-lab-summary" class="nav-link" data-scroll-target="#lab-summary"><span class="header-section-number">4.7</span> Lab Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Capital Asset Pricing Model (CAPM) Empirical Test</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="lab-objectives" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="lab-objectives"><span class="header-section-number">4.1</span> Lab Objectives</h2>
<ol type="1">
<li><strong>Master the cross-sectional regression method for CAPM testing</strong>: Learn to use the cross-sectional regression method for CAPM validation.</li>
<li><strong>Use Python for CAPM empirical testing</strong>: Become familiar with using Python for data acquisition, regression analysis, and results analysis.</li>
<li><strong>Test the applicability of the CAPM model in the Chinese stock market</strong>: Empirically test whether the CAPM model holds in the Chinese stock market using Chinese stock market data.</li>
<li><strong>Understand the limitations of the CAPM model</strong>: Deepen understanding of the CAPM model’s limitations through empirical results.</li>
</ol>
<hr>
</section>
<section id="lab-principles" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="lab-principles"><span class="header-section-number">4.2</span> Lab Principles</h2>
<section id="capm-model-review" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="capm-model-review"><span class="header-section-number">4.2.1</span> CAPM Model Review</h3>
<p>The Capital Asset Pricing Model (CAPM) describes the relationship between the expected return of a risky asset and its systematic risk. Its core formula is the Security Market Line (SML):</p>
<p><span class="math inline">\(E(R_i) = R_f + \beta_i[E(R_m) - R_f]\)</span></p>
<p>Where:</p>
<ul>
<li><span class="math inline">\(E(R_i)\)</span>: Expected return of asset <span class="math inline">\(i\)</span></li>
<li><span class="math inline">\(R_f\)</span>: Risk-free rate</li>
<li><span class="math inline">\(\beta_i\)</span>: Beta coefficient of asset <span class="math inline">\(i\)</span>, measuring systematic risk</li>
<li><span class="math inline">\(E(R_m)\)</span>: Expected return of the market portfolio</li>
<li><span class="math inline">\([E(R_m) - R_f]\)</span>: Market risk premium</li>
</ul>
</section>
<section id="empirical-testing-methods-for-capm-model" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="empirical-testing-methods-for-capm-model"><span class="header-section-number">4.2.2</span> Empirical Testing Methods for CAPM Model</h3>
<p>This lab will use the <strong>Portfolio Grouping method</strong> to empirically test the CAPM model.</p>
<p><strong>Portfolio Grouping Method</strong></p>
<p>To address the issue of large estimation errors in individual stock Betas, we use the portfolio grouping method for CAPM testing. This method was first proposed by Black, Jensen, and Scholes (1972) and can significantly reduce the impact of Beta estimation errors on test results.</p>
<p>The empirical model is as follows:</p>
<p><span class="math inline">\(\overline{R}_{p} = \gamma_{0} + \gamma_{1} \overline{\beta}_p + \eta_{p}\)</span></p>
<ul>
<li><span class="math inline">\(\gamma_{0}\)</span> represents the expected return of the zero-Beta portfolio. If CAPM holds, <span class="math inline">\(\gamma_{0}\)</span> should be close to the risk-free rate <span class="math inline">\(R_f\)</span>.</li>
<li><span class="math inline">\(\gamma_{1}\)</span> represents the risk premium. If CAPM holds, <span class="math inline">\(\gamma_{1}\)</span> should be equal to the market risk premium <span class="math inline">\(E(R_m) - R_f\)</span> and be significantly positive.</li>
<li><span class="math inline">\(\overline{R}_{p}\)</span> and <span class="math inline">\(\overline{\beta}_p\)</span> are the average return and average Beta of the portfolio, respectively.</li>
</ul>
<p><strong>Steps:</strong></p>
<ol type="1">
<li><strong>Step 1: Time-series regression to estimate individual stock Beta values</strong>: Use a time-series regression model to estimate the Beta value <span class="math inline">\(\beta_i\)</span> for each stock <span class="math inline">\(i\)</span>.</li>
<li><strong>Step 2: Group stocks by Beta size</strong>: Divide stocks into multiple portfolios based on their Beta values (this lab uses 10 groups).</li>
<li><strong>Step 3: Calculate portfolio characteristics</strong>: Calculate the average Beta and average return for each portfolio.</li>
<li><strong>Step 4: Portfolio-level regression</strong>: Perform a cross-sectional regression using the average Beta and average return of the portfolios.</li>
</ol>
<p>Compared to directly using individual stock data for cross-sectional regression, the portfolio grouping method has the following advantages: - Reduces the impact of Beta estimation errors, improving the robustness of test results. - Diversifies unsystematic risk, better capturing the relationship between Beta and average returns. - Reduces the influence of outliers on regression results. - Is more consistent with the practice of investors holding diversified portfolios.</p>
</section>
</section>
<section id="lab-data" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="lab-data"><span class="header-section-number">4.3</span> Lab Data</h2>
<p>This lab uses data from the Chinese A-share market for testing.</p>
<ul>
<li><strong>Stock Data</strong>: Shanghai A-shares are selected as the research subjects.</li>
<li><strong>Market Index</strong>: The Shanghai Composite Index is used as a proxy for the market portfolio.</li>
<li><strong>Risk-Free Rate</strong>: Chinese government bond rates are used as a proxy for the risk-free rate.</li>
<li><strong>Data Period</strong>: Historical data from 2015 to 2024 is selected.</li>
<li><strong>Data Frequency</strong>: Weekly data is used.</li>
</ul>
<p><strong>Data Source</strong>: CSMAR (accessible via university IP)</p>
</section>
<section id="lab-steps" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="lab-steps"><span class="header-section-number">4.4</span> Lab Steps</h2>
<section id="import-necessary-python-libraries" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1" class="anchored" data-anchor-id="import-necessary-python-libraries"><span class="header-section-number">4.4.1</span> Import Necessary Python Libraries</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Read market index data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># The market index represents the overall market performance and is the market portfolio in the CAPM model.</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>index_files <span class="op">=</span> <span class="st">"./data/mktret_weekly/TRD_Weekm.xlsx"</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> pd.read_excel(index_files, header<span class="op">=</span><span class="dv">0</span>, skiprows<span class="op">=</span><span class="dv">3</span>, names<span class="op">=</span>[<span class="st">'Markettype'</span>, <span class="st">'Trdwnt'</span>, <span class="st">'Wretwdos'</span>, <span class="st">'Dnstkcal'</span>])</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the float-adjusted market capitalization-weighted average return (Wretwdos) for the Shanghai A-share market (Markettype=1).</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The float-adjusted market capitalization-weighted average return better represents true market performance as it considers the market size of different stocks.</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> market_data[market_data[<span class="st">'Markettype'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trdwnt (YYYY-WW) into two variables: year and week.</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>market_data[<span class="st">'year'</span>] <span class="op">=</span> market_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[:<span class="dv">4</span>]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>market_data[<span class="st">'week'</span>] <span class="op">=</span> market_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[<span class="dv">5</span>:]</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for the years 2015 to 2024.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Selecting data from the last 10 years ensures sufficient sample size and reflects current market characteristics.</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> market_data[market_data[<span class="st">'year'</span>] <span class="op">&gt;=</span> <span class="st">'2015'</span>]</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> market_data[market_data[<span class="st">'year'</span>] <span class="op">&lt;=</span> <span class="st">'2024'</span>]</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Read risk-free rate data</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># The risk-free rate is an important component of the CAPM model, representing the minimum return investors require without taking any risk.</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>rf_files <span class="op">=</span> <span class="st">"./data/rf_weekly/TRD_Nrrate.xlsx"</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>rf_data <span class="op">=</span> pd.read_excel(rf_files, header<span class="op">=</span><span class="dv">0</span>, skiprows<span class="op">=</span><span class="dv">2</span>, names<span class="op">=</span>[<span class="st">'Nrr1'</span>, <span class="st">'Clsdt'</span>, <span class="st">'Nrrdaydt'</span>])</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert rf from percentage units to decimals.</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardizing units facilitates subsequent calculation of excess returns.</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>rf_data[<span class="st">'Nrrdaydt'</span>] <span class="op">=</span> rf_data[<span class="st">'Nrrdaydt'</span>] <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Clsdt to datetime format.</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>rf_data[<span class="st">'Clsdt'</span>] <span class="op">=</span> pd.to_datetime(rf_data[<span class="st">'Clsdt'</span>])</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Clsdt to trading week format (week number starts from 1).</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># This step is to convert daily data to weekly data, consistent with stock and market data.</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>rf_data[<span class="st">'Trdwnt'</span>] <span class="op">=</span> rf_data[<span class="st">'Clsdt'</span>].dt.strftime(<span class="st">'%Y-%U'</span>).<span class="bu">apply</span>(</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">.</span>split(<span class="st">'-'</span>)[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span><span class="bu">int</span>(x.split(<span class="st">'-'</span>)[<span class="dv">1</span>]) <span class="op">+</span> <span class="dv">1</span><span class="sc">:02d}</span><span class="ss">"</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trdwnt into two variables: year and week.</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>rf_data[<span class="st">'year'</span>] <span class="op">=</span> rf_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[:<span class="dv">4</span>]</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>rf_data[<span class="st">'week'</span>] <span class="op">=</span> rf_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[<span class="dv">5</span>:]</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average of rf for each year and week.</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Since there might be multiple risk-free rate data points within a week, take the average as the representative value for that week.</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>rf_data <span class="op">=</span> rf_data.groupby([<span class="st">'year'</span>, <span class="st">'week'</span>]).agg({<span class="st">'Nrrdaydt'</span>: <span class="st">'mean'</span>}).reset_index()</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for the years 2015 to 2024.</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>rf_data <span class="op">=</span> rf_data[rf_data[<span class="st">'year'</span>] <span class="op">&gt;=</span> <span class="st">'2015'</span>]</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>rf_data <span class="op">=</span> rf_data[rf_data[<span class="st">'year'</span>] <span class="op">&lt;=</span> <span class="st">'2024'</span>]</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Read all stock return data (2015-2024)</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual stock returns are the core data for CAPM testing, used for estimating Beta and validating model predictions.</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Read all excel files in stockret_weekly</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>stockret_folders <span class="op">=</span> <span class="st">"./data/stockret_weekly"</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>stock_files <span class="op">=</span> glob(os.path.join(stockret_folders, <span class="st">"*.xlsx"</span>))</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Found stock data files: </span><span class="sc">{</span>stock_files<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store all stock data</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>stock_data_list <span class="op">=</span> []</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through and read files</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> stock_files:</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    temp_data <span class="op">=</span> pd.read_excel(<span class="bu">file</span>, header<span class="op">=</span><span class="dv">0</span>, skiprows<span class="op">=</span><span class="dv">3</span>, names<span class="op">=</span>[<span class="st">'Stkcd'</span>, <span class="st">'Trdwnt'</span>, <span class="st">'Wretwd'</span>, <span class="st">'Markettype'</span>])</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    stock_data_list.append(temp_data)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Concatenate all stock data</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> pd.concat(stock_data_list, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only Shanghai A-share market (Markettype=1)</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Maintain consistency with the market index to ensure sample uniformity.</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> stock_data[stock_data[<span class="st">'Markettype'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Trdwnt into two variables: year and week.</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>stock_data[<span class="st">'year'</span>] <span class="op">=</span> stock_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[:<span class="dv">4</span>]</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>stock_data[<span class="st">'week'</span>] <span class="op">=</span> stock_data[<span class="st">'Trdwnt'</span>].<span class="bu">str</span>[<span class="dv">5</span>:]</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for the years 2015 to 2024.</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> stock_data[stock_data[<span class="st">'year'</span>] <span class="op">&gt;=</span> <span class="st">'2015'</span>]</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> stock_data[stock_data[<span class="st">'year'</span>] <span class="op">&lt;=</span> <span class="st">'2024'</span>]</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the number of unique values for Stkcd.</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Understanding how many stocks are included in the sample; a larger sample size makes the results more representative.</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of unique Stkcd values: </span><span class="sc">{</span>stock_data[<span class="st">'Stkcd'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Merge DataFrames</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge stock, market, and risk-free rate data to prepare for subsequent analysis.</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge stock_data with market_data on ['year', 'week']</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(stock_data, market_data, on<span class="op">=</span>[<span class="st">'year'</span>, <span class="st">'week'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge merged_data with rf_data on ['year', 'week']</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> pd.merge(merged_data, rf_data, on<span class="op">=</span>[<span class="st">'year'</span>, <span class="st">'week'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new column 'market_excess_return', calculate market excess return.</span></span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a><span class="co"># Market excess return = Market return - Risk-free rate, representing the additional return gained from taking market risk.</span></span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">'market_excess_return'</span>] <span class="op">=</span> merged_data[<span class="st">'Wretwdos'</span>] <span class="op">-</span> merged_data[<span class="st">'Nrrdaydt'</span>]</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate market risk premium.</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Market risk premium is an important parameter in the CAPM model, representing compensation for bearing systematic risk.</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>market_risk_premium <span class="op">=</span> merged_data[<span class="st">'market_excess_return'</span>].mean()</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Market risk premium: </span><span class="sc">{</span>market_risk_premium<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Time-series regression to estimate Beta</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta is the core parameter of the CAPM model, measuring the sensitivity of individual stocks to market risk.</span></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="co"># First, perform a regression on one stock to test the results.</span></span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for Stkcd == 600169</span></span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>merged_data0 <span class="op">=</span> merged_data[merged_data[<span class="st">'Stkcd'</span>] <span class="op">==</span> <span class="dv">600169</span>]</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform regression (with missing value handling)</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co"># First, delete rows containing missing values.</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>merged_data0 <span class="op">=</span> merged_data0.dropna(subset<span class="op">=</span>[<span class="st">'market_excess_return'</span>, <span class="st">'Wretwd'</span>])</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform time-series regression: R_i = α_i + β_i(R_m - R_f) + ε_i</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Here, we directly use total return instead of excess return as the dependent variable; this is a modified CAPM testing method.</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(merged_data0[<span class="st">'Wretwd'</span>], sm.add_constant(merged_data0[<span class="st">'market_excess_return'</span>])).fit()</span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Display regression results</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co"># The constant term represents Alpha, the slope represents Beta.</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.summary())</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a><span class="co"># Group merged_data by stkcd, perform regression, y is Wretwd, x is market_excess_return</span></span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Store regression results in the time_series_results dictionary.</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>time_series_results <span class="op">=</span> {}</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> stock_code <span class="kw">in</span> merged_data[<span class="st">'Stkcd'</span>].unique():</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>    individual_data <span class="op">=</span> merged_data[merged_data[<span class="st">'Stkcd'</span>] <span class="op">==</span> stock_code]</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First, delete rows containing missing values.</span></span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    individual_data <span class="op">=</span> individual_data.dropna(subset<span class="op">=</span>[<span class="st">'market_excess_return'</span>, <span class="st">'Wretwd'</span>])</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for more than 30 rows, otherwise skip.</span></span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Too small a sample size will lead to unreliable regression results.</span></span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(individual_data) <span class="op">&gt;</span> <span class="dv">30</span>:</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(individual_data[<span class="st">'Wretwd'</span>], sm.add_constant(individual_data[<span class="st">'market_excess_return'</span>])).fit()</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>        time_series_results[stock_code] <span class="op">=</span> model</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Stock </span><span class="sc">{</span>stock_code<span class="sc">}</span><span class="ss"> has fewer than 30 rows, skipping."</span>)</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract beta values from regression results.</span></span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Beta value represents the sensitivity of individual stocks to market risk. Beta &gt; 1 indicates the stock is more volatile than the market.</span></span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>beta_values <span class="op">=</span> [result.params[<span class="dv">1</span>] <span class="cf">for</span> result <span class="kw">in</span> time_series_results.values()]</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a><span class="co"># beta_values need to be merged with corresponding stock codes.</span></span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>beta_values <span class="op">=</span> pd.DataFrame({<span class="st">'Stkcd'</span>: <span class="bu">list</span>(time_series_results.keys()), <span class="st">'beta'</span>: beta_values})</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Use the portfolio grouping method to test the CAPM model</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a><span class="co"># The portfolio grouping method involves grouping stocks by Beta, calculating portfolio average Beta and return,</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a><span class="co"># then performing regression. This significantly reduces the impact of Beta estimation errors and improves the robustness of test results.</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Group beta_values into 10 equal groups from smallest to largest, create a 'group' column.</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Grouping can reduce the impact of idiosyncratic risk and better test the relationship between systematic risk and return.</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>beta_values[<span class="st">'group'</span>] <span class="op">=</span> pd.qcut(beta_values[<span class="st">'beta'</span>], q<span class="op">=</span><span class="dv">10</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge stock data based on stock code.</span></span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>capm_data <span class="op">=</span> pd.merge(stock_data, beta_values, on<span class="op">=</span><span class="st">'Stkcd'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a><span class="co"># Group capm_data by 'group', calculate average stock return and average beta for each group, store in a DataFrame.</span></span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolios can diversify unsystematic risk and better reflect the relationship between Beta and return.</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>group_data <span class="op">=</span> capm_data.groupby(<span class="st">'group'</span>).agg({<span class="st">'Wretwd'</span>: <span class="st">'mean'</span>, <span class="st">'beta'</span>: <span class="st">'mean'</span>})</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a><span class="co"># Regress Wretwd on beta, calculate intercept and slope.</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression model: R_i = γ_0 + γ_1 * β_i + η_i</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a><span class="co"># γ_0 should be close to the risk-free rate, γ_1 should be close to the market risk premium.</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> sm.OLS(group_data[<span class="st">'Wretwd'</span>], sm.add_constant(group_data[<span class="st">'beta'</span>])).fit()</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Display regression results</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model.summary())</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract and interpret results</span></span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>gamma_0 <span class="op">=</span> model.params[<span class="st">'const'</span>]  <span class="co"># Zero-Beta portfolio return</span></span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>gamma_1 <span class="op">=</span> model.params[<span class="st">'beta'</span>]   <span class="co"># Estimated market risk premium</span></span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>p_value_gamma_0 <span class="op">=</span> model.pvalues[<span class="st">'const'</span>]  <span class="co"># Significance of zero-Beta portfolio return</span></span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>p_value_gamma_1 <span class="op">=</span> model.pvalues[<span class="st">'beta'</span>]   <span class="co"># Significance of market risk premium</span></span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">CAPM Cross-Sectional Regression Results Interpretation:"</span>)</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"γ0 (Zero-Beta portfolio return) = </span><span class="sc">{</span>gamma_0<span class="sc">:.6f}</span><span class="ss">, p-value = </span><span class="sc">{</span>p_value_gamma_0<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"γ1 (Market risk premium) = </span><span class="sc">{</span>gamma_1<span class="sc">:.6f}</span><span class="ss">, p-value = </span><span class="sc">{</span>p_value_gamma_1<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Actual market risk premium = </span><span class="sc">{</span>market_risk_premium<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPM test conclusion</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">CAPM Test Conclusion:"</span>)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> p_value_gamma_0 <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"- γ0 (</span><span class="sc">{</span>gamma_0<span class="sc">:.6f}</span><span class="ss">) is significant, indicating the existence of a zero-Beta portfolio return."</span>)</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"- γ0 (</span><span class="sc">{</span>gamma_0<span class="sc">:.6f}</span><span class="ss">) is not significant, cannot determine the zero-Beta portfolio return."</span>)</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> p_value_gamma_1 <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> gamma_1 <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"- γ1 (</span><span class="sc">{</span>gamma_1<span class="sc">:.6f}</span><span class="ss">) is significantly positive, indicating that Beta risk is priced by the market."</span>)</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(gamma_1 <span class="op">-</span> market_risk_premium) <span class="op">&lt;</span> <span class="fl">0.01</span>: <span class="co"># A threshold for "close"</span></span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  And it is close to the actual market risk premium (</span><span class="sc">{</span>market_risk_premium<span class="sc">:.6f}</span><span class="ss">), supporting the CAPM model."</span>)</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  However, there is a difference from the actual market risk premium (</span><span class="sc">{</span>market_risk_premium<span class="sc">:.6f}</span><span class="ss">), CAPM model is partially supported."</span>)</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"- γ1 (</span><span class="sc">{</span>gamma_1<span class="sc">:.6f}</span><span class="ss">) is significant but negative, which contradicts CAPM expectations, indicating Beta risk is not correctly priced."</span>)</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"- γ1 (</span><span class="sc">{</span>gamma_1<span class="sc">:.6f}</span><span class="ss">) is not significant, indicating that Beta risk is not priced by the market, CAPM model is not supported in this sample."</span>)</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Plotting</span></span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the average Beta and return of portfolios on a graph, along with the regression line.</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a><span class="co">###################################</span></span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a><span class="co"># Set plotting style</span></span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'ggplot'</span>)</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Set different fonts based on the operating system</span></span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Get operating system type</span></span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>system <span class="op">=</span> platform.system()</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a><span class="co"># Set matplotlib font</span></span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> system <span class="op">==</span> <span class="st">'Windows'</span>:</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>    plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [<span class="st">'SimHei'</span>]  <span class="co"># Windows uses SimHei</span></span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> system <span class="op">==</span> <span class="st">'Darwin'</span>:</span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>    plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [<span class="st">'Songti SC'</span>]  <span class="co"># Mac uses Songti SC</span></span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>    plt.rcParams[<span class="st">'font.sans-serif'</span>] <span class="op">=</span> [<span class="st">'WenQuanYi Zen Hei'</span>]  <span class="co"># Linux uses WenQuanYi Zen Hei</span></span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a><span class="co"># Resolve the issue of negative signs not displaying correctly</span></span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">'axes.unicode_minus'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot and save</span></span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>plt.scatter(group_data[<span class="st">'beta'</span>], group_data[<span class="st">'Wretwd'</span>], alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>plt.plot(group_data[<span class="st">'beta'</span>], gamma_0 <span class="op">+</span> gamma_1 <span class="op">*</span> group_data[<span class="st">'beta'</span>], <span class="st">'r-'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Relationship between Beta and Average Return'</span>) <span class="co"># Title in English</span></span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Beta Coefficient'</span>) <span class="co"># X-axis label in English</span></span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Average Weekly Return'</span>) <span class="co"># Y-axis label in English</span></span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>plt.annotate(<span class="ss">f'R2 = </span><span class="sc">{</span>model<span class="sc">.</span>rsquared<span class="sc">:.4f}</span><span class="ss">'</span>, xy<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>), xycoords<span class="op">=</span><span class="st">'axes fraction'</span>)</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>plt.annotate(<span class="ss">f'γ0 = </span><span class="sc">{</span>gamma_0<span class="sc">:.6f}</span><span class="ss">'</span>, xy<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.90</span>), xycoords<span class="op">=</span><span class="st">'axes fraction'</span>)</span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>plt.annotate(<span class="ss">f'γ1 = </span><span class="sc">{</span>gamma_1<span class="sc">:.6f}</span><span class="ss">'</span>, xy<span class="op">=</span>(<span class="fl">0.05</span>, <span class="fl">0.85</span>), xycoords<span class="op">=</span><span class="st">'axes fraction'</span>)</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>plt.savefig(<span class="st">'capm_scatter.png'</span>)</span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Scatter plot of Beta vs. Average Return has been saved."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="lab-results" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="lab-results"><span class="header-section-number">4.5</span> Lab Results</h2>
<p>This lab tested the CAPM model using the portfolio grouping method. If the CAPM model holds, we expect:</p>
<ol type="1">
<li>The intercept term (<span class="math inline">\(\gamma_0\)</span>) should be close to the risk-free rate, representing the return of a zero-Beta portfolio.</li>
<li>The Beta coefficient (<span class="math inline">\(\gamma_1\)</span>) should be significantly positive and close to the market risk premium, representing compensation for bearing systematic risk.</li>
</ol>
<p>The figure below shows the scatter plot of portfolio average Beta versus average return and the regression line:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="./images/capm_scatter.png" class="img-fluid figure-img"></p>
<figcaption>Relationship between Beta and Average Return</figcaption>
</figure>
</div>
</section>
<section id="conclusion-and-discussion" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="conclusion-and-discussion"><span class="header-section-number">4.6</span> Conclusion and Discussion</h2>
<p>Based on the experimental results of the portfolio grouping method, we can analyze the applicability of the CAPM model in the Chinese A-share market:</p>
<ol type="1">
<li><strong>Pricing of Systematic Risk</strong>:
<ul>
<li>Observe whether the Beta coefficient in the portfolio regression is significant and its explanatory power (R-squared).</li>
<li>The R-squared value represents the portion of the portfolio’s average return that can be explained by Beta.</li>
<li>Compared to individual stock regressions, the R-squared of portfolio regressions is usually higher because grouping reduces the impact of idiosyncratic risk.</li>
</ul></li>
<li><strong>Zero-Beta Portfolio Return</strong>:
<ul>
<li>Compare the difference between <span class="math inline">\(\gamma_0\)</span> and the risk-free rate.</li>
<li>If <span class="math inline">\(\gamma_0\)</span> is significantly higher than the risk-free rate, other risk factors may not have been captured by the model.</li>
<li>The study by Black, Jensen, and Scholes (1972) indicated that the zero-Beta portfolio return is often higher than the risk-free rate.</li>
</ul></li>
<li><strong>Risk Premium</strong>:
<ul>
<li>Test whether <span class="math inline">\(\gamma_1\)</span> is significantly positive and compare it with the actual market risk premium.</li>
<li>If <span class="math inline">\(\gamma_1\)</span> is significantly positive and close to the market risk premium, it supports the CAPM model.</li>
<li>If <span class="math inline">\(\gamma_1\)</span> is not significant or is negative, it indicates that systematic risk is not correctly priced by the market.</li>
</ul></li>
<li><strong>Limitations of the CAPM Model</strong>:
<ul>
<li>Specifics of the Chinese stock market: policy-driven, retail investor dominance, information asymmetry.</li>
<li>Other risk factors may need to be considered: size effect, value effect, momentum effect, etc.</li>
<li>Even if the portfolio grouping method reduces estimation errors, CAPM may still not fully explain return differentials in the Chinese market.</li>
</ul></li>
</ol>
<p>Through these analyses, we can assess the applicability of the CAPM model in the Chinese market and discuss its possible limitations.</p>
</section>
<section id="lab-summary" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="lab-summary"><span class="header-section-number">4.7</span> Lab Summary</h2>
<p>This lab tested the applicability of the CAPM model in the Chinese A-share market using the portfolio grouping method. We first estimated the Beta coefficients of individual stocks, then grouped the stocks by Beta size, calculated the average Beta and average return for the portfolios, and finally examined the relationship between Beta and average return.</p>
<p>Compared to directly using individual stock data, the portfolio grouping method has the following advantages: 1. Reduces the impact of Beta estimation errors. 2. Diversifies unsystematic risk. 3. Reduces the influence of outliers on regression results. 4. Is more consistent with the practice of investors holding diversified portfolios.</p>
<p>This type of empirical testing not only helps us verify financial theories but also provides empirical evidence for investment decisions and asset pricing. By comparing theoretical expectations with empirical results, we can gain a deeper understanding of the risk-return characteristics of the Chinese stock market, providing guidance for portfolio construction and risk management.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./02_capm.html" class="pagination-link" aria-label="Capital Asset Pricing Model (CAPM)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Capital Asset Pricing Model (CAPM)</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03_ff3.html" class="pagination-link" aria-label="Fama-French Three-Factor Model">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Fama-French Three-Factor Model</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>