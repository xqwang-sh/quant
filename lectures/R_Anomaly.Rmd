---
title: "中国股票市场三因子与ROE异象"
author: "汪小圈"
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: united
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
options(knitr.kable.NA = '')
```

# 导言

## 目标

- 构造中国三因子

- 考察ROE异象（研究方法包括投资组合方法与Fama-Macbeth回归法）

## 数据来源

CSMAR(国泰安) http://cn.gtadata.com/

- 基本信息: 公司研究系列 -> 上市公司基本信息 -> 上市公司基本信息年度表

- 借壳上市：专题研究系列 -> 事件研究 -> 公司事件 -> IPO事件表

- 股票市场信息: 股票市场系列 -> 股票市场交易 -> 个股交易数据 -> 月个股回报率文件

- 无风险利率: 股票市场系列 -> 股票市场交易 -> 汇率及利率 -> 无风险利率文件

- 多因子: 因子研究系列 -> Fama-French因子 -> 五因子模型指标(月)

- 财务数据: 公司研究系列 -> 财务指标分析 -> 披露财务指标


## 选取样本与变量

- 2007/1-2019/2, 上海与深圳A股非金融、非公用事业上市企业

- 基本信息: 

    - 上市公司年度基本信息：股票代码、行业代码、上市日期
    
    - IPO信息：借壳日期

- 股票市场信息

    - 个股交易信息: 考虑现金红利再投资的月个股回报率、月个股总市值
    
    - 无风险利率: 月度化无风险利率
    
    - 五因子: 市场风险溢价因子(总市值加权)、市值因子(总市值加权)、账面市值比因子(总市值加权)

- 财务信息
    
    - 披露财务指标（2007-）：归属于上市公司股东的扣除非经常性损益的净利润、加权平均净资产收益率
    
## 分解目标

- Step 1: 导入整理数据，保证各数据库间的变量及单位等保持一致

- Step 2: 选取A股非金融、非公用事业上市公司

- Step 3: 合并上市公司股票信息与财务信息，并保留市值处于最大的70%的上市企业

- Step 4: 每月根据市值与价值对企业进行排序分组，并计算每个投资组合的市值加权平均收益率

- Step 5: 构造中国三因子，并计算中国三因子在中国市场的解释力度

- Step 6: 构造ROE异象，比较CAPM、中国三因子与Fama-French三因子模型的 $\alpha$

- Step 7: 使用Fama-Macbeth方法，考察ROE是否能够解释中国股票超额收益率


# 准备工作
```{r}
# 加载需要的R包
library(tidyverse)
library(readxl)
library(lubridate)
library(broom)
library(furrr)
library(fixest)
library(lmtest)
library(sandwich) #NeweyWest
library(modelsummary)
library(gt)
```

- 保存R Script, 并修改工作目录到R Script所在的文件夹(`Session -> Set Working Directory -> To Source File Location`)

- 所有数据都保存在该文件夹中的子文件夹"Anomaly_data"中


# 导入数据
```{r}
# 基本信息
cominfo <- read_excel("Anomaly_data/STK_LISTEDCOINFOANL.xlsx")

# 财务指标
comfin <- read_excel("Anomaly_data/FI_T2.xlsx", col_names = c("Stkcd", "Accper", "Indcd", "nr", "npexnr", "ROE", "ROE_exnr"), skip = 3)

# 个股交易数据
trdmnth <- read_excel("Anomaly_data/TRD_Mnth.xlsx")

# 无风险利率
nrrate <- read_excel("Anomaly_data/TRD_Nrrate.xlsx")

# 五因子
facmnth <- read_excel("Anomaly_data/STK_MKT_FIVEFACMONTH.xlsx")
```

# 整理数据

## 筛选满足条件的A股上市企业

- A股
- 非金融行业、非公用事业行业
- 保留上市后数据
- 借壳上市公司识别为新公司


```{r}
# 行业信息
indinfo <- cominfo %>% 
  count(IndustryName, IndustryCode) %>% 
  arrange(IndustryCode)

# A股、非金融公用事业行业
comA <- cominfo %>% 
  mutate(
    EndDate = ymd(EndDate),
    year = year(EndDate),
    LISTINGDATE = ymd(LISTINGDATE)
  ) %>% 
  filter(
    EndDate >= LISTINGDATE,
    !str_starts(IndustryCode, "J"), !str_starts(IndustryCode, "D"),
    str_sub(Symbol, 1, 3) != "900", str_sub(Symbol, 1, 3) != "200"
  )

# 借壳上市
IPO <- read_excel("Anomaly_data/ER_IPO.xlsx") %>% 
  filter(ListSign == "A") %>% 
  mutate(RMyear = LatestBackdoorDate %>% ymd() %>% year()) %>% 
  select(Symbol, RMyear)

# 重新定义证券ID
comA_all <- comA %>% 
  left_join(IPO) %>% 
  group_by(Symbol) %>% 
  mutate(Symbol1 = case_when(
    is.na(RMyear) ~ str_c(Symbol, "0"),
    year >= RMyear ~ str_c(Symbol, "2"),
    TRUE ~ str_c(Symbol, "1"))
  ) %>% 
  select(Symbol, Symbol1, year, RMyear) %>% 
  ungroup()
```

## 整理各个数据集
```{r}
# 财务数据在补缺失时针对同一家企业进行填补
comfin1 <- comfin %>% 
  mutate(
    Accper = ymd(Accper),
    year = year(Accper),
    month = month(Accper)
  ) %>% 
  inner_join(comA_all, by = c("Stkcd" = "Symbol", "year" = "year")) %>% 
  filter(is.na(RMyear) | year != RMyear) %>% 
  complete(Symbol1, year, month) %>% 
  arrange(Symbol1, year, month) %>% 
  group_by(Symbol1) %>% 
  fill(npexnr, ROE, .direction = "down") %>% 
  ungroup()

trdmnth <- trdmnth %>% 
  mutate(
    ym = ym(Trdmnt),
    year = year(ym),
    month = month(ym),
    Mretwd = Mretwd*100
  ) 

nrrate <- nrrate %>% 
  filter(Nrr1 == "NRI01") %>% 
  mutate(
    Clsdt = ymd(Clsdt),
    year = year(Clsdt),
    month = month(Clsdt)
    ) %>% 
  group_by(year, month) %>% 
  summarise(rf = mean(Nrrmtdt))

# 挑选综合A股和创业板和科创板的因子
facmnth <- facmnth %>% 
  filter(MarkettypeID == "P9714", Portfolios == 1) %>% 
  mutate(ym = ym(TradingMonth)) %>% 
  mutate(across(RiskPremium1:CMA2, ~.*100))
```


## 合并数据集与构造变量

把股票数据与财务数据合并，合并结果存储在`trddata`中

构造下列变量：

- 总市值 = 上个月月末收盘价*总股数

- 市盈率 = 扣除非经常损益后的净利润 / 总市值

筛选市值最大的70%的企业

最后计算超额收益率

```{r}
# 一季报最晚4/30披露，二季报最晚8/30披露，三季报最晚10/31披露
# 年报最晚至4/30披露
trddata <- trdmnth %>% 
  mutate(
    year1 = if_else(month >= 1 & month <= 4, year - 1, year),
    month1 = case_when(
      month == 5 | month == 6 | month == 7 | month == 8 ~ 3,
      month == 9 | month == 10 ~ 6,
      TRUE ~ 9
    )
  ) %>% 
  inner_join(comfin1, by = c("Stkcd", "year1" = "year", "month1" = "month")) %>% 
  complete(Symbol1, ym) %>% 
  arrange(Symbol1, ym) %>% 
  group_by(Symbol1) %>% 
  mutate(
    size = lag(Mclsprc) * (Msmvttl/Mclsprc),
    EP = npexnr / size
  ) %>% 
  group_by(ym) %>% 
  filter(size >= quantile(size, 0.3, na.rm = TRUE)) %>% 
  left_join(nrrate) %>% 
  mutate(
    exret = Mretwd - rf
  ) %>% 
  filter(ym >= ym("2007-05"), ym <= ym("2019-02"))
```


# 因子模型
## 对size、value、ROE进行排序分组
```{r}
trddata_grp <- trddata %>% 
  group_by(ym) %>% 
  mutate(
    grp_size = ntile(size, 2),
    grp_value = case_when(
      is.na(EP) ~ NA_real_,
      EP <= quantile(EP, 0.3, na.rm = TRUE) ~ 1,
      EP <= quantile(EP, 0.7, na.rm = TRUE) ~ 2,
      TRUE ~ 3
    ),
    grp_ROE = ntile(ROE, 10),
    grp_size1 = ntile(size, 10)
  ) %>% 
  group_by(ym, grp_size1) %>% 
  mutate(
    grp_ROE_con = ntile(ROE, 10)
  ) %>% 
  ungroup()
```


## 计算加权平均股票回报率与定价因子
```{r}
# Value-weighted return
factor1 <- trddata_grp %>% 
  group_by(ym) %>% 
  summarise(
    MKT = weighted.mean(exret, size, na.rm = TRUE)
  ) %>% 
  ungroup()
  
factor2 <- trddata_grp %>% 
  group_by(ym, grp_size, grp_value) %>% 
  summarise(
    vwret = weighted.mean(Mretwd, size, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  filter(!is.na(grp_size), !is.na(grp_value)) %>% 
  mutate(grp = grp_size*10 + grp_value) %>% 
  select(ym, grp, vwret) %>% 
  pivot_wider(names_from = grp, values_from = vwret) %>% 
  mutate(
    SMB = 1/3*(`11` + `12` + `13`) - 1/3*(`21` + `22` + `23`),
    VMG = 1/2*(`13` + `23`) - 1/2*(`11` + `21`)
  )

# 与Fama-French因子数据合并
factor <- factor2 %>%
  left_join(factor1) %>% 
  left_join(facmnth)
```

# Size and value in China
## 描述性统计分析
```{r results='asis'}
# 使用datasummary
# 描述性统计量
factor %>% 
  select(MKT, SMB, VMG) %>% 
  datasummary(
    MKT + SMB + VMG ~ Ncol + Mean + SD +  P0 + P25 + Median + P75 + P100, 
    data = .,
    output = "gt"
  ) 

# 相关系数
factor %>% 
  select(MKT, SMB, VMG) %>% 
  cor(use = "complete.obs", method = "pearson") %>% 
  as_tibble() %>% 
  gt() %>% 
  fmt_number(decimals = 3)
```

## 因子模型解释能力
```{r results="asis"}
# R-square
# All but the smallest 30% of stocks
rsq <- trddata %>% 
  left_join(factor) %>% 
  filter(!is.na(exret), !is.na(MKT)) %>% 
  group_by(Symbol1) %>% 
  filter(n() >= 12) %>% 
  nest() %>% 
  mutate(
    `MKT` = data %>% map(~lm(exret ~ MKT, .)) %>% map(glance) %>% map_dbl("r.squared"),
    `MKT, SMB` = data %>% map(~lm(exret ~ MKT + SMB, .)) %>% map(glance) %>% map_dbl("r.squared"),
    `MKT, VMG` = data %>% map(~lm(exret ~ MKT + VMG, .)) %>% map(glance) %>% map_dbl("r.squared"),
    `MKT, SMB, VMG` = data %>% map(~lm(exret ~ MKT + SMB + VMG, .)) %>% map(glance) %>% map_dbl("r.squared")
  ) %>% 
  select(-data)

# summarise
rsq %>% 
  pivot_longer(`MKT`:`MKT, SMB, VMG`, names_to = "Factors", values_to = "rsq") %>% 
  group_by(Factors) %>% 
  summarise(`Avg. R-square` = mean(rsq)) %>% 
  gt()

# use feols to compute all regressions
trddata1 <- trddata %>% 
  left_join(factor) %>% 
  filter(!is.na(exret), !is.na(MKT)) %>% 
  group_by(Symbol1) %>% 
  filter(n() >= 12) 
  
models <- trddata1 %>% 
  feols(exret ~ MKT + sw0(SMB, VMG, SMB + VMG), split = ~Symbol1, nthreads = 0)

rsq <- tibble(
  rhs = models %>% map_chr(c("model_info", "rhs")),
  Symbol = models %>% map_chr(c("model_info", "sample", "value")),
  r2 = models %>% map_dbl("sq.cor")
)

# summarise
rsq %>% 
  group_by(rhs) %>% 
  summarise(`Avg. R-square` = mean(r2)) %>% 
  rename(Factors = rhs) %>% 
  gt()
```

# ROE异象

## 投资组合分析

- 时间序列回归
- 标准误差的估计使用Newey West方法调整

```{r results="asis"}
# unconditional sort
factor3 <- trddata_grp %>% 
  group_by(ym, grp_ROE) %>% 
  summarise(
    vwret = weighted.mean(Mretwd, size, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  filter(!is.na(grp_ROE)) %>% 
  pivot_wider(names_from = "grp_ROE", values_from = "vwret") %>% 
  mutate(
    rmw = `10` - `1`
  ) %>% 
  select(ym, rmw)

# size-neutral sort
factor4 <- trddata_grp %>% 
  group_by(ym, grp_ROE_con) %>% 
  summarise(
    vwret = weighted.mean(Mretwd, size, na.rm = TRUE)
  ) %>% 
  ungroup() %>% 
  filter(!is.na(grp_ROE_con)) %>% 
  pivot_wider(names_from = "grp_ROE_con", values_from = "vwret") %>% 
  mutate(
    rmw_sn = `10` - `1`
  ) %>% 
  left_join(factor3) %>% 
  left_join(factor)

# factor model
fmodel <- factor4 %>% 
  feols(c(rmw, rmw_sn) ~ MKT + sw0(SMB + VMG, SMB2 + HML2), vcov = NW(4) ~ ym)

# etable(fmodel)

# change names
names(fmodel) <- str_c("(", 1:6, ")")

# show results
tab <- modelsummary(fmodel, output = "gt",
                    coef_map = c("(Intercept)" = "Alpha", 
                                 "MKT" = "MKT", "SMB" = "SMB", "VMG" = "VMG", 
                                 "SMB2" = "FFSMB", "HML2" = "FFHML"),
                    gof_omit = "AIC|BIC|RMSE|Std.Errors",
                    stars = c('*' = .1, '**' = .05, '***' = .01))

# output
tab %>%
  # column labels
  tab_spanner(label = "Unconditional", columns = 2:4) %>% 
  tab_spanner(label = "Conditional", columns = 5:7) 
```


## Fama-Macbeth 数据预处理

- 计算每支股票的 $\beta$ (已完成，代码见下面部分)：每支股票、每个月底，使用前250个交易日的日度股票收益率对市场收益率做回归（CAPM）得到的回归系数$\beta$

- 三因子与Fama-Macbeth回归中的变量对应：

    - 市场因子： $\beta$
    - 市值因子：市值的对数 (lnMe)
    - 价值因子：earnings-to-price ratio (EP+ & D(EP<0))

```{r eval=FALSE}
# Read stock daily return
stkdaily <- read_rds("D:/OneDrive/Courses/Research/2023/slides/Topic3_Event/data/stkdaily/stkdaily.rds") %>% 
  mutate(year = year(Trddt), month = month(Trddt)) %>%
  left_join(comA_all, by = c("Stkcd" = "Symbol", "year" = "year")) %>% 
  filter(!is.na(RMyear) | year != RMyear)

# Calculate CAPM beta
stkmonth <- stkdaily %>%
  group_by(Symbol1, year, month) %>%
  filter(Trddt == max(Trddt)) %>%
  mutate(tail = 1) %>%
  select(Symbol1, Trddt, tail)

library(tibbletime) #rollify
rolling_beta <- rollify(function(A, B){lm(A ~ B)},
                        window = 250,
                        unlist = F)

stk_beta <- stkdaily %>%
  left_join(stkmonth) %>%
  group_by(Symbol1) %>%
  filter(n() > 300) %>%
  mutate(
    model = if_else(tail == 1, rolling_beta(exret, RiskPremium2), NULL)
  ) %>%
  filter(!is.na(model)) %>%
  mutate(
    coef = model %>% map(tidy)
  ) %>%
  select(Symbol1, Trddt, coef) %>%
  unnest(coef) %>%
  filter(term == "B") %>%
  select(Symbol1, Trddt, estimate) %>%
  mutate(year = year(Trddt), month = month(Trddt))

write_rds(stk_beta, "Anomaly_data/beta.rds")
```

```{r}
stk_beta <- read_rds("Anomaly_data/beta.rds")

trddata_fm <- trddata %>%
  left_join(stk_beta, by = c("Stkcd", "year", "month")) %>%
  rename(Beta = estimate) %>%
  mutate(
    lnMe = log(size),
    EP_pos = if_else(EP >= 0, EP, 0),
    EP_dum = if_else(EP < 0, 1, 0)
  )
```

## Fama-Macbeth回归

两个步骤：

- 针对每月，将本月股票收益率对上一月的企业特征进行横截面回归；

- 将时间序列上的回归系数取平均，并对这些系数进行t检验，标准误差的估计使用Newey West方法调整

```{r echo=FALSE, eval=FALSE, results="asis"}
fmmodels <- trddata_fm %>% 
  feols(exret ~ sw(Beta, lnMe, 
                   Beta + lnMe, 
                   Beta + lnMe + EP_pos + EP_dum, 
                   Beta + ROE, 
                   Beta + lnMe + EP_pos + EP_dum + ROE), 
        split = ~ym, nthreads = 0)

fmmodels[[1]] %>% str

fmresult <- tibble(
  rhs = fmmodels %>% map_chr(c("model_info", "rhs")),
  ym = fmmodels %>% map_chr(c("model_info", "sample", "value")),
  coefs = fmmodels %>% map(tidy),
  r2 = fmmodels %>% map_dbl("sq.cor"),
  nobs = fmmodels %>% map_int("nobs")
) %>% 
  unnest(coefs)

fmmodels1 <- fmresult %>% 
  mutate(regname = str_c(rhs, term)) %>%
  feols(estimate ~ 1, vcov = NW(4) ~ ym, split = ~regname, nthreads = 0) 
fmcoef <- tibble(
  rhs = fmmodels %>% map_chr(c("model_info", "sample", "value")),
  coefs = fmmodels %>% map(tidy)
)
```

```{r results="asis"}
fm_model <- function(model){
  fmcoef <- trddata_fm %>%
    group_by(ym) %>%
    nest() %>%
    mutate(
      coefs = data %>% map(~lm(model, .)) %>% map(tidy)
    ) %>%
    select(-data) %>%
    unnest() %>%
    group_by(term) %>%
    nest() %>%
    mutate(
      fmtest = data %>% map(~lm(estimate ~ 1, .)),
      fmsd = fmtest %>% map(~coeftest(., vcov = NeweyWest(., lag = 4))) %>% map(tidy)
    ) %>%
    select(term, fmsd) %>%
    unnest() %>%
    mutate(varnm = str_c(round(estimate, 3), "\n", "(", round(statistic, 3), ")")) %>%
    select(term, varnm)

  fmrsq <- trddata_fm %>%
    group_by(ym) %>%
    nest() %>%
    mutate(
      rsq = data %>% map(~lm(model, .)) %>% map(glance)
    ) %>%
    select(-data) %>%
    unnest() %>%
    ungroup() %>%
    summarise(across(c(adj.r.squared, nobs), mean)) %>%
    mutate(Adj.R2 = round(adj.r.squared, 3),
           N = round(nobs, 0)) %>%
    select(Adj.R2, N) %>%
    pivot_longer(Adj.R2:N, names_to = "term", values_to = "varnm") %>% 
    mutate(varnm = as.character(varnm))

  rbind(fmcoef, fmrsq)
}

fmcoef1 <- fm_model(exret ~ Beta)

fmcoef2 <- fm_model(exret ~ lnMe)

fmcoef3 <- fm_model(exret ~ Beta + lnMe)

fmcoef4 <- fm_model(exret ~ Beta + lnMe + EP_pos + EP_dum)

fmcoef5 <- fm_model(exret ~ Beta + ROE)

fmcoef6 <- fm_model(exret ~ Beta + lnMe + EP_pos + EP_dum + ROE)

rowname <- tribble(~term,
                   "(Intercept)",
                   "Beta",
                   "lnMe",
                   "EP_pos",
                   "EP_dum",
                   "ROE",
                   "Adj.R2",
                   "N")

rowname %>% left_join(fmcoef1) %>%
  left_join(fmcoef2, by = c("term" = "term")) %>%
  left_join(fmcoef3, by = c("term" = "term")) %>%
  left_join(fmcoef4, by = c("term" = "term")) %>%
  left_join(fmcoef5, by = c("term" = "term")) %>%
  left_join(fmcoef6, by = c("term" = "term")) %>%
  rename(
    `(1)` = varnm.x,
    `(2)` = varnm.y,
    `(3)` = varnm.x.x,
    `(4)` = varnm.y.y,
    `(5)` = varnm.x.x.x,
    `(6)` = varnm.y.y.y
  ) %>%
  gt() %>% 
  fmt_missing(missing_text = "")
```
