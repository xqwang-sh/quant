---
title: "收益模型与组合优化"
author: "汪小圈"
date: 2025-05-13
format:
  beamer:
    theme: Copenhagen
    colortheme: default
    fonttheme: serif
    navigation: horizontal
    aspectratio: 169
    header-includes: |
      \usepackage{ctex}
      \usepackage{graphicx}
lang: zh
---

## 课程结构

- **Part 1: 收益率预测模型——寻找阿尔法**
  - 引言与基本概念
  - 预测变量的来源与实例
  - 预测变量的筛选标准详解
  - 收益率预测的具体流程与方法
  
- **Part 2: 风险模型——以Barra为例**
  - 风险模型的基本概念
  - Barra多因子模型结构
  - 模型求解与纯因子投资组合
  - 协方差矩阵的求解与调整
  
- **Part 3: 投资组合优化与实践考量**
  - 收益与风险模型错位问题
  - 常见的组合优化目标函数
  - 优化中的常见约束条件
  - 交易成本的考量
  - 策略回测与评估要点

## 收益率预测模型——寻找阿尔法

- 量化投资追求**系统性、纪律性**地获取超越市场基准的收益（阿尔法）
- 需要复杂模型的原因：市场有效性假说下，无风险超额收益难以持续存在
- 通过严谨的**数据分析**和**模型构建**，发掘市场中的**定价偏差**或**风险补偿**机会
- 投资组合优化帮助我们在预期收益、风险暴露、交易成本和约束间权衡
- 本讲遵循 **预测→优化** 的逻辑链条

## 基本术语澄清

- **预测变量 (Return Predictors)**: 
  - 用于**预测**未来收益率的指标、特征或信号
  - 例：市净率、动量、分析师盈利预测修正等
  - 构建收益模型的基础

- **因子 (Factors)**: 
  - 解释资产收益**共同变动**的系统性风险来源
  - 或用于捕捉风险溢价的**投资组合**
  - 例：Fama-French三因子中的SMB, HML

- **阿尔法 (Alpha)**: 
  - 资产定价模型**无法解释**的超额收益
  - 衡量投资经理技巧或策略有效性的指标（定价误差）

## 关键区别与联系

- 预测变量有效性可能源于：
  - 捕捉到未被主流风险因子定价的**阿尔法**（错误定价）
  - 对某种风险因子暴露的衡量（风险补偿）
  
- 例：低市净率可能有效是因为：
  - 代表了价值因子暴露（获取风险溢价）
  - 捕捉到市场对价值股的暂时性错误定价

- 本讲使用：
  - "预测变量"：指代用于预测收益的指标
  - "因子"：指代风险因子或因子组合
  - "阿尔法"：指代定价模型残差或超额收益目标

## 寻找预测变量

- 最经典、最常用的领域
- **价值类**：低市净率(P/B)、低市盈率(P/E)、低市销率(P/S)、高股息率
  - 逻辑：买入被低估的公司
  
- **动量类**：过去6-12个月收益率高(Momentum)
  - 逻辑：赢者恒赢的趋势持续
  
- **反转类**：过去1个月收益率低(Short-term Reversal)
  - 逻辑：对短期过度反应的修正

- **质量类**：高净资产收益率(ROE)、高毛利率(Gross Profitability)、低财务杠杆、稳健的盈利增长
  - 逻辑：优质公司长期表现更优
  
- **低风险/低波动类**：低历史波动率、低Beta
  - 逻辑："低风险异象"，低风险股票有更高的风险调整后收益
  
- **其他**：小市值、流动性、机构持股变化、分析师预期修正等

## 改进已有变量

随着市场演变和研究深入，需要不断改进现有变量

- **考虑无形资产的价值因子**：
  - 传统P/B可能低估技术、医药等行业公司价值
  - 加入研发投入、品牌价值等调整Book Value
  
- **经行业调整的因子**：
  - 某些指标在行业间不可比（如金融业P/B）
  - 进行行业中性化处理或计算行业内相对值
  
- **动态调整因子**：
  - 因子有效性可能具有周期性（如动量在市场剧烈反转时失效）
  - 结合市场状态进行调整或切换

## 挑选预测变量的标准（1）

理想的预测变量应满足六大核心标准：

1. 逻辑性 (Intuitiveness)
- **要求**：变量背后应有合理的经济学或行为金融学解释
- **重要性**：避免数据挖掘，防止偶然发现的伪相关
- **检验**：文献回顾，思考经济学含义，构建合理故事

2. 持续性 (Persistence)
- **要求**：预测能力在样本内外都能持续存在
- **检验方法**：信息系数(IC)、分层回测、因子衰减分析

## 挑选预测变量的标准（2）

3. 信息增量性 (Information Increasement)
- **要求**：提供相对于已有变量的额外、独立预测信息
- **检验方法**：变量相关性分析、条件排序法、Fama-MacBeth回归

4. 稳健性 (Robustness)
- **要求**：有效性不应过度依赖特定参数设定、算法、样本区间或市场环境
- **检验方法**：参数敏感性、算法敏感性、样本区间检验、不同市场检验

## 挑选预测变量的标准（3）

5. 可投资性 (Investability)
- **要求**：策略能在现实中以合理成本和规模进行投资
- **考量**：信息衰减速度、换手率、交易成本、流动性、策略容量

6. 普适性 (Pervasiveness)
- **要求**：在不同市场、资产类别、时间段内均有效
- **意义**：增强因子逻辑性和稳健性信心，降低数据挖掘可能性
- **实例**：价值、规模、动量效应在多个市场普遍存在

## 信息系数 (IC) 详解

- **定义**：预测变量与未来收益率的截面相关系数 $IC_t = corr(z_{it}, R_{it+1})$

- **评估指标**：
  - **IC均值** $\overline{IC}$：衡量平均预测能力
    - 通常月频|IC|>2%或日频|IC|>1%有潜力
  - **IC标准差** $\sigma_{IC}$：衡量预测能力稳定性
  - **信息比率** $IR = \frac{\overline{IC}}{\sigma_{IC}}$：预测能力的"夏普比率"
    - IR > 0.5通常较好
  - **IC的t统计量** $t(IC) = \frac{\overline{IC}}{\sigma_{IC} / \sqrt{T}}$
    - |t|>2通常认为显著

## 分层回测 (Portfolio Sort)

基本步骤：

1. 每期期末，根据预测变量 $z_{it}$ 对股票进行排序
2. 将股票分成N组（如5组或10组）
3. 构建多空组合：做多预期最好的一组，做空预期最差的一组
4. 计算该多空组合在下一期的收益率
5. 重复以上步骤，得到多空组合的净值曲线

评估：观察净值曲线趋势，计算年化收益、夏普比率、最大回撤等指标

## 收益率预测流程（1）

1. **确定投资范围 (Universe Selection)**
   - **原始股票池**：如全部A股、沪深300、中证500、特定行业
   - **优化股票池**（剔除黑名单）：
     - 流动性过低：日均交易额过小、长期停牌
     - 风险过高：ST、*ST、即将退市、净资产为负
     - 上市时间过短：次新股
     - 某些负面特征：极高换手率、异常波动等

2. **剔除预测变量异常值 (Outlier Treatment)**
   - 常用方法：
     - 缩尾法 (Winsorization)
     - 截尾法 (Trimming)
     - 标准差法
     - 中位数绝对偏差法 (MAD) (**推荐**)

## 收益率预测流程（2）

3. **预测收益率 (Return Forecasting)**
   
- **非参数化预测**：
  - **条件选股法**：根据指标阈值筛选股票
  - **排序打分法 (Ranking and Scoring)**：
    1. 计算因子值 $z_{kit}$
    2. 因子标准化：Z-Score计算
    3. 多因子合成：等权、IC加权、分层合成
    4. 最终排序：预期得分越高的股票未来收益越高
   
- **优点**：选股数量可控，相对简单
- **缺点**：未完全利用因子与收益间的定量关系，权重设定主观

## 收益率预测流程（3）

- **参数化预测 (线性回归)**：
  - **方法一：基于历史系数的预测**
    1. 每期截面回归：$R_{it} = c_t + b_t z_{it-1} + \epsilon_{it}$
    2. 得到系数时间序列 $c_t, b_t$
    3. 计算历史系数均值 $\bar{c}, \bar{b}$
    4. 预测：$\hat{R}_{i,T+1} = \bar{c} + \bar{b} z_{iT}$
    
  - **方法二：基于面板回归的预测**
    1. 面板回归：$R_{it} = c + b z_{it-1} + \alpha_i + \eta_t + \epsilon_{it}$
    2. 得到估计系数 $\hat{c}, \hat{b}$
    3. 预测：$\hat{R}_{i,T+1} = \hat{c} + \hat{b} z_{iT}$

## 风险模型简介

组合优化不仅是最大化预期收益，更是在收益和风险间进行权衡。风险模型（协方差矩阵 $\Sigma$）与收益模型同等重要。

- **为何需要风险模型?**
  - **风险衡量**：量化组合整体风险（波动率、VaR）
  - **风险分解**：理解风险来源（市场？行业？风格？）
  - **风险控制**：在优化中限制特定风险暴露
  - **优化输入**：协方差矩阵是大多数优化目标函数的关键输入

## 常见风险模型类型

- **因子模型 (Factor Models)**：
  - 假设股票收益波动主要由共同因子暴露驱动
  - $R_i = \alpha_i + \sum_{k=1}^K \beta_{ik} f_k + \epsilon_i$
  - 优点：降维、结构清晰、易解释
  - 代表：Barra模型（包含国家、行业、风格因子）

- **其他类型**：
  - **统计模型**：通过PCA等从历史收益提取主成分
  - **直接历史协方差矩阵**：简单但噪声大，维度灾难
  - **压缩估计 (Shrinkage)**：如Ledoit-Wolf压缩
  - **指数加权移动平均 (EWMA)**：强调近期数据

## Barra多因子模型结构

Barra模型是由MSCI开发的一系列风险模型，广泛应用于投资组合风险管理。

- **基本结构**：Barra CNE5模型（中国市场第五代风险模型）包含三类因子：
  - **国家因子**：单一因子，代表整体市场风险
  - **行业因子**：多个行业因子，代表不同行业特有风险
  - **风格因子**：包括规模、价值、动量、波动率、流动性等

- **模型表示**：
  $R_{it}^e = \beta_{i}^C \lambda_{Ct} + \sum_{p=1}^{P} \beta_{i}^{I_p} \lambda_{I_p,t} + \sum_{q=1}^{Q} \beta_{i}^{S_q} \lambda_{S_q,t} + u_{it}$

## 因子暴露的确定

Barra模型的特点是风格因子暴露的确定方法：

1. **直接使用公司特征**：
   - 使用市值对数作为规模因子暴露
   - 使用账面市值比作为价值因子暴露

2. **标准化处理**：
   - 市值加权去均值：确保市场组合在任何风格因子上暴露为零
   - 除以标准差：使不同因子的暴露具有可比性

3. **行业因子特殊处理**：
   - 为避免共线性问题，对行业因子收益率施加约束：
   - $s_{I_1}\lambda_{I_1,t} + s_{I_2}\lambda_{I_2,t} + \cdots + s_{I_P}\lambda_{I_P,t} = 0$
   - 其中$s_{I_p}$是行业$I_p$的市值权重

## 纯因子投资组合

Barra模型求解过程中得到的权重矩阵$\Omega$的每一行代表一个"纯因子投资组合"：

1. **国家因子的纯因子投资组合**：
   - 近似等于市场组合
   - 在国家因子上暴露为1
   - 在所有风格因子上暴露为0

2. **行业因子的纯因子投资组合**：
   - 资金中性（权重和为0）
   - 100%做多该行业，100%做空国家因子投资组合
   - 在所有风格因子上暴露为0

3. **风格因子的纯因子投资组合**：
   - 资金中性
   - 仅在该风格因子上有1个单位的暴露
   - 在其他所有因子上暴露为0

## 协方差矩阵的求解与调整

风险模型的核心目标是估计股票的协方差矩阵$\Sigma$：

- **协方差矩阵分解**：$\Sigma = \beta \Sigma_{\lambda} \beta' + \Sigma_{\epsilon}$
  - $\Sigma_{\lambda}$是因子协方差矩阵
  - $\Sigma_{\epsilon}$是特质性收益率的协方差矩阵（对角矩阵）

- **直接估计的挑战**：
  - **噪声大**：历史样本协方差矩阵包含大量噪声
  - **非平稳性**：市场结构和波动性是时变的
  - **维度灾难**：股票数量N很大时，计算困难

- **调整方法**：
  - **特征因子调整法**：对因子协方差矩阵进行特征分解和调整
  - **贝叶斯收缩法**：利用先验信息稳定特质风险估计

## Part 3: 投资组合优化与实践考量

- 前两部分：我们探讨了预测收益的方法和风险模型
- 现在面临的问题：如何利用这些预测信息和风险估计，结合现实约束，构建**最优投资组合**？
- 这就是**投资组合优化 (Portfolio Optimization)** 要解决的核心问题

## 收益与风险模型错位 (Misalignment)

一个实践中重要但常被忽视的问题：**Alpha模型与Risk模型可能不一致**

- **问题根源**：
  - Alpha模型关注**预测变量** $z_{\alpha}$
  - Risk模型关注**风险因子** $f_R$
  - 当 $z_{\alpha}$ 不能被 $f_R$ 完全解释时，就发生了错位

- **影响**：
  - 预期收益分解：$\mu = \mu_{\parallel} + \mu_{\perp}$
  - $\mu_{\parallel}$: 能被风险模型解释的部分
  - $\mu_{\perp}$: 不能被风险模型解释的部分（在风险模型看来是特质风险）
  - 优化器会**低估** $\mu_{\perp}$ 真实风险，**过度配置**这部分"伪阿尔法"

## 解决模型错位问题

- **调整风险模型**（理论上可行，实践中困难）：
  - 将Alpha模型中的预测变量纳入风险模型作为风险因子
  - 可能需要构建自己的风险模型，在使用第三方模型时不可行

- **改进优化过程**（更常用）：
  - 在目标函数中加入对"无法解释的阿尔法"$\mu_{\perp}$ 的额外惩罚
  - $\max_{\omega} \omega' \mu - \frac{\zeta}{2} \omega' \Sigma \omega - \frac{\theta}{2} \omega' (\mu_{\perp} \mu_{\perp}') \omega$
  - 这实质上是增加了对 $\mu_{\perp}$ 方向风险的惩罚
  - $\mu_{\perp}$ 可通过将 $\mu$ 对风险因子 $\beta_R$ 回归取残差得到

## 常见目标函数（1）

给定预期收益 $\mu$ 和协方差矩阵 $\Sigma$，投资组合优化的目标是在收益和风险间找到最佳平衡点。

1. 均值-方差优化 (MVO)
- **目标**：最大化预期收益，同时惩罚组合风险
  $\max_{\omega} \quad \omega' \mu - \frac{\zeta}{2} \omega' \Sigma \omega$
- **无约束解**：$\omega_{mvo} = (\zeta \Sigma)^{-1} \mu$
- **直观理解**：在所有预期收益相同的组合中选择最小风险的；反之亦然
- **优点**：理论基础坚实（基于效用最大化），明确权衡风险和收益
- **缺点**：参数敏感性高、易产生极端权重、被称为"误差最大化器"

## 常见目标函数（2）

2. 最小方差 (Minimum Variance)
- **目标**：找到最低风险的投资组合，不考虑预期收益
  $\min_{\omega} \quad \omega' \Sigma \omega$ （通常 $\omega' \mathbf{1} = 1$）
- **最优解**：$\omega_{mv} = \frac{\Sigma^{-1} \mathbf{1}}{\mathbf{1}' \Sigma^{-1} \mathbf{1}}$
- **优点**：不依赖难以准确预测的 $\mu$，结果更稳健
- **缺点**：完全忽略收益目标，可能选出预期收益很低的组合
- **适用场景**：对收益预测极度不自信时，或首要目标是风险最小化

## 常见目标函数（3）

3. 最大多样化 (Maximum Diversification)
- **目标**：最大化多样化比率（各资产加权平均波动率/组合波动率）
  $\max_{\omega} \quad \frac{\omega' \sigma}{\sqrt{\omega' \Sigma \omega}}$
- **最优解**：$\omega_{md} \propto \Sigma^{-1} \sigma$
- **直观理解**：通过资产间低相关性分散风险
- **优点**：关注风险分散化，不直接依赖 $\mu$

4. 风险平价 (Risk Parity)
- **目标**：使每个资产对组合总风险的贡献相等
- **风险贡献**：$\omega_i \times \frac{\partial \sigma_p}{\partial \omega_i} = \frac{\omega_i (\Sigma \omega)_i}{\sigma_p}$
- **特殊条件下解**：$\omega_{rp,i} \propto 1 / \sigma_i$
- **优点**：实现风险均衡分配，不依赖 $\mu$，在多资产配置中流行

## 不同目标函数的比较与等价条件

这些优化目标函数在特定条件下是等价的：

- **MVO是最一般化框架**，其他几种是MVO在特定假设下的特例：
  - **最小方差**：假设所有资产预期超额收益相等
  - **最大多样化**：假设所有资产预期夏普比率相等
  - **风险平价**：假设资产夏普比率相等且相关系数相等
  - **等权重**：假设夏普比率、相关系数、波动率都相等

- **核心启示**：
  - 选择哪种优化方法反映了你对输入参数（尤其是$\mu$）的信心
  - $\mu$预测有信心→MVO；无信心→最小方差/风险平价
  - 实践中需在MVO理论最优和其他方法稳健性间权衡

## 常见约束条件（1）

理论最优解往往不符合现实限制，优化中必须加入各种约束条件：

1. 预算约束 (Budget Constraint)
- **全投资**：$\sum_i \omega_i = 1$
- **允许现金**：$\sum_i \omega_i \le 1$
- **美元中性**：$\sum_i \omega_i = 0$（多空策略）

2. 卖空约束 (Short-Selling Constraint)
- **禁止卖空**：$\omega_i \ge 0$
- **限制卖空**：$\omega_i \ge -L_{short}$
- **原因**：监管限制、券源限制、风险控制

## 常见约束条件（2）

3. 头寸上下限约束 (Position Limits)
- **个股层面**：$L_i \le \omega_i \le U_i$（如单只股票不超过5%）
- **组合层面**：$L_p \le \sum_{i \in \text{Group } p} \omega_i \le U_p$（如单一行业不超过20%）
- **原因**：分散化要求、流动性考虑、监管要求

4. 换手率约束 (Turnover Constraint)
- **目标**：限制相对于上期组合 $\omega^-$ 的调整幅度，控制交易成本
- **个股换手**：$|\omega_i - \omega^-_i| \le \phi_i$
- **组合总换手**：$\sum_i |\omega_i - \omega^-_i| \le \Phi$
- **原因**：交易成本侵蚀收益，过频交易可能是噪音

## 常见约束条件（3）

5. 持仓数量约束 (Cardinality Constraint)
- **目标**：控制持股数量范围
- **形式**：$N_L \le \sum_i \delta_i \le N_U$（$\delta_i$是0/1变量）
- **影响**：引入整数变量使问题变为混合整数规划，计算复杂度增加

6. 因子暴露约束 (Factor Exposure Constraint)
- **绝对暴露**：$L_k \le \sum_i \omega_i \beta_{ik} \le U_k$
- **主动暴露**：$L_k \le \sum_i (\omega_i - \omega_{Bi}) \beta_{ik} \le U_k$
- **风格中性/行业中性**：使特定因子暴露为零或等于基准暴露
- **原因**：主动管理风险，确保组合特征符合预期

## 常见约束条件（4）

7. 跟踪误差约束 (Tracking Error Constraint)
- **目标**：控制相对于基准组合 $B$ 的波动性
- **形式**：$(\omega - \omega_B)' \Sigma (\omega - \omega_B) \le \sigma^2_{TE, max}$
- **原因**：适用于指数增强或相对收益策略

8. 约束的影响
- **降低理论最优性**：加入约束通常使目标函数表现下降
- **提高实际可行性**：使组合满足现实要求，更易管理执行
- **改变组合结构**：直接影响最终权重分配
- **计算复杂度**：某些约束（如整数约束）显著增加求解难度
- **可能无解**：过于严格或冲突的约束可能导致无可行解

## 交易成本模型（1）

交易成本直接侵蚀策略收益，应在优化阶段就纳入考量：
$\max_{\omega} \underbrace{\left( \omega' \mu - \frac{\zeta}{2} \omega' \Sigma \omega \right)}_{\text{原始目标函数}} - \underbrace{\gamma_{TC} TC(\omega, \omega^-)}_{\text{交易成本惩罚项}}$

1. 交易成本构成
- **显性成本**：
  - 佣金：券商收取的费用
  - 印花税：政府收取的税费
  - 交易所规费等
  
- **隐性成本**：
  - 价差成本：买入价-卖出价的差额
  - 冲击成本：交易对市场价格的不利影响（**机构投资者最大成本来源**）
  - 机会成本：未能及时完成交易错失的价格变动

## 交易成本模型（2）

2. 常用成本模型
- **线性成本函数**：
  $TC(\omega) = \sum_i c_i |\omega_i - \omega^-_i|$
  - 假设单位交易成本固定，适用小额交易
  
- **二次成本函数**（考虑冲击成本）：
  $TC(\omega) = \sum_i c_i |\omega_i - \omega^-_i| + \sum_i d_i (\omega_i - \omega^-_i)^2$
  - 增加交易量平方项模拟冲击成本
  - 交易量越大，单位冲击成本越高
  
- **更复杂模型**：分段线性函数、幂函数等

## 回测与评估（1）

绝不能直接投入实盘，必须通过严格回测评估策略表现

1. 回测的重要性
- **绩效评估**：检验策略在过去市场中的表现
- **模型验证**：验证模型假设有效性
- **参数调优**：调整模型参数（警惕过拟合）
- **风险识别**：发现可能的极端风险
- **可行性检验**：考虑交易成本、流动性后策略是否仍有利可图

2. 关键回测指标
- **收益类**：年化收益率、累计收益率
- **风险类**：年化波动率、最大回撤、VaR、条件VaR
- **风险调整收益**：夏普比率、索提诺比率、信息比率
- **交易类**：年化换手率、平均持仓周期

## 回测与评估（2）

3. 回测中的常见陷阱
- **前视偏差**：使用当时尚未发生的未来信息
  - 如用当天收盘价做当天开盘决策
  - 用发布日晚于决策日的财务数据
  - 对全样本标准化后用于历史决策
  
- **幸存者偏差**：只用当前存在的股票数据，忽略已退市公司
  - 高估策略表现
  - 必须使用包含已退市股票的数据库
  
- **数据挖掘/过拟合偏差**：过度拟合历史，找到噪音而非规律
  - 解决：坚持经济逻辑、严格区分样本内外、交叉验证、正则化

## 回测与评估（3）

4. 更多回测陷阱
- **未充分考虑交易成本和冲击**：假设理想价格成交
  - 应加入合理交易成本模型
  
- **忽略流动性约束**：假设可无限量交易任何股票
  - 小盘或低流动性股票难以承载大资金

5. 好的回测实践
- 使用高质量、干净、包含退市股票的数据
- 严格模拟实际交易流程，避免前视偏差
- 包含合理的交易成本和滑点假设
- 进行严格的样本外测试
- 分析极端事件和风险暴露
- 进行多维度归因分析，理解收益和风险来源

## 总结

本次课深入探讨了量化投资策略构建的三个核心支柱：

- **收益预测方面**：
  - 寻找预测变量（传统数据、另类数据）
  - 筛选标准（逻辑性、持续性、增量性、稳健性、可投资性、普适性）
  - 转化为具体预测的方法（打分法、回归法等）
  - **核心**：找到真正有效、稳健且具逻辑支撑的阿尔法来源

- **风险模型方面**：
  - Barra风险模型的结构和应用
  - 因子暴露的确定方法
  - 协方差矩阵的估计与调整
  - **核心**：准确评估风险，理解风险来源，为优化提供关键输入

- **组合优化方面**：
  - 收益与风险模型错位问题
  - 不同优化目标函数（MVO、最小方差、最大多样化、风险平价）
  - 各类约束条件和交易成本模型
  - **核心**：转化为风险可控、成本有效、满足现实约束的最优组合

- **量化投资是不断迭代、持续优化的过程**
- **目标**：构建能穿越市场周期、持续创造价值的投资策略

